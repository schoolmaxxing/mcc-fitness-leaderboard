<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCC Fitness Leaderboard</title>
    <link rel="icon" type="image/x-icon" href="icon.png">
    <style>
        /* Global Reset & Base */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            /* Smoother fonts on WebKit */
            -moz-osx-font-smoothing: grayscale;
            /* Smoother fonts on Firefox */
        }

        .container {
            width: 100%;
            max-width: 500px;
            background: #1e1e1e;
            border-radius: 12px;
            /* Slightly more rounded */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.35);
            /* Softer, more diffused shadow */
            padding: 25px;
            text-align: center;
        }

        h1,
        h2,
        h3 {
            color: #f5f5f5;
            /* Slightly softer than pure white */
            margin-top: 0;
        }

        h1 {
            margin-bottom: 24px;
        }

        h2 {
            margin-bottom: 20px;
        }

        h3 {
            margin-bottom: 16px;
        }

        /* General h3, may be overridden specifically */


        /* Panel System */
        .panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }

        .hidden {
            display: none;
        }

        /* Leaderboard Styles */
        .leaderboard {
            list-style: none;
            padding: 0;
            width: 100%;
        }

        .leaderboard li {
            padding: 15px;
            margin: 10px 0;
            background: #2d2d2d;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* Vertically align items */
            font-size: 18px;
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }

        .leaderboard li:hover {
            background-color: #383838;
            transform: translateY(-2px);
        }

        .leaderboard li .points {
            font-weight: bold;
            color: #b0b0b0;
            /* Slightly muted points color */
        }

        .leaderboard li.gold {
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.25) 0%, #2d2d2d 60%);
            border-left: 5px solid #D4AF37;
        }

        .leaderboard li.silver {
            background: linear-gradient(90deg, rgba(192, 192, 192, 0.20) 0%, #2d2d2d 60%);
            border-left: 5px solid #C0C0C0;
        }

        .leaderboard li.bronze {
            background: linear-gradient(90deg, rgba(205, 127, 50, 0.25) 0%, #2d2d2d 60%);
            border-left: 5px solid #CD7F32;
        }

        /* Buttons */
        button {
            padding: 12px 20px;
            border-radius: 8px;
            /* Consistent rounding */
            border: none;
            background: #1976D2;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            width: 100%;
            max-width: 300px;
            margin: 5px 0;
            text-align: center;
            /* Ensure text is centered if not by default */
        }

        button:hover {
            background: #1565C0;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(0px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        button:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.5);
            /* Accent color focus ring */
        }

        /* Muted/Secondary Buttons */
        .button-group button.back-home,
        .button-group button.back-to-menu,
        .button-group button.back-to-leaderboard,
        #points-menu .button-group button:last-child {
            /* Cancel button in points menu */
            background-color: #3e3e3e;
            color: #d0d0d0;
            font-weight: normal;
        }

        .button-group button.back-home:hover,
        .button-group button.back-to-menu:hover,
        .button-group button.back-to-leaderboard:hover,
        #points-menu .button-group button:last-child:hover {
            background-color: #4a4a4a;
            color: #ffffff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .button-group button.back-home:focus,
        .button-group button.back-to-menu:focus,
        .button-group button.back-to-leaderboard:focus,
        #points-menu .button-group button:last-child:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(100, 100, 100, 0.5);
        }


        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            align-items: center;
        }

        .button-group.vertical {
            gap: 15px;
        }

        /* Forms */
        input,
        select,
        textarea {
            width: 100%;
            max-width: 300px;
            padding: 12px;
            border-radius: 8px;
            /* Consistent rounding */
            border: 1px solid #383838;
            /* Slightly lighter border */
            background: #2d2d2d;
            color: #e0e0e0;
            /* Match body text color */
            font-size: 16px;
            margin: 5px 0;
            font-family: inherit;
            /* Inherit body font */
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #1976D2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.4);
        }

        select {
            /* Make select arrow match theme (basic) */
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2220%22%20height%3D%2220%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%3E%3Cpath%20d%3D%22M5%208l5%205%205-5z%22%20fill%3D%22%23e0e0e0%22/%3E%3C/svg%3E');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            padding-right: 30px;
            /* Space for arrow */
        }


        .error {
            color: #ef5350;
            /* Softer red */
            margin: 10px 0;
            font-weight: bold;
        }

        /* Rules */
        .rules-content {
            text-align: center;
            background: #2a2a2a;
            /* Slightly different from other panel items */
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 18px;
            line-height: 1.8;
            /* Increased line-height */
            width: 100%;
        }

        .rules-content p {
            margin: 15px 0;
        }

        .note {
            font-style: italic;
            color: #a0a0a0;
            /* Lighter than #aaa */
            margin-top: 25px !important;
        }

        /* Chat Styles */
        .chat-container {
            height: 400px;
            width: 100%;
            overflow-y: auto;
            border: 1px solid #333;
            border-radius: 8px;
            margin-bottom: 15px;
            background: #252525;
            /* Slightly darker chat background */
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        #chat-messages {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            flex-grow: 1;
            list-style: none;
            padding: 0;
        }

        #chat-messages li {
            background: #3d3d3d;
            padding: 12px 15px;
            /* Adjusted padding */
            border-radius: 8px;
            word-wrap: break-word;
            max-width: 100%;
            font-size: 16px;
        }

        .message-header {
            font-weight: bold;
            margin-bottom: 8px;
            color: #64b5f6;
            /* Lighter blue for sender */
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }

        .message-sender {
            font-weight: bold;
        }

        .message-time {
            color: #909090;
            /* Lighter time */
            font-size: 0.8em;
        }

        .message-body {
            padding: 8px 0;
            font-size: 16px;
            line-height: 1.5;
            /* Better readability for messages */
        }

        .chat-input-container {
            display: flex;
            gap: 5%;
            width: 100%;
            align-items: center;
            /* Keep button aligned to bottom of textarea */
        }

        #chat-input {
            flex: 1;
            border-radius: 8px;
            background: #2d2d2d;
            color: #ffffff;
            font-size: 16px;
            resize: none;
            height: 100px;
            width:100%;
            line-height: 1.5;
            overflow-y: auto;
        }

        #send-button {
            height: 100px;
            /* Match min-height of textarea for alignment */
            width: 30%;
            /* Standard button padding */
            margin: 0;
            /* Remove specific margin if not needed for alignment */
            flex-shrink: 0;
            /* Prevent button from shrinking */
        }

        #send-button:hover,
        #send-button:active {
            transform: none;
            /* Removes the vertical movement */
        }

        /* Profile View Styles */
        .profile-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .profile-header {
            text-align: center;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
        }

        #profile-username {
            color: #f5f5f5;
            /* Ensure matches general heading */
        }

        #profile-total-points {
            font-weight: bold;
            color: #81c784;
            /* Greenish for points */
        }

        .profile-stats-container {
            display: flex;
            gap: 15px;
            width: 100%;
            flex-direction: column;
        }

        .stat-box {
            flex: 1;
            background: #2d2d2d;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .stat-box h3 {
            margin-top: 0;
            margin-bottom: 10px;
            /* Ensure space before content */
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
            color: #e0e0e0;
            /* Slightly less emphasis than main headers */
        }

        .stat-item {
            background: #3d3d3d;
            padding: 10px 12px;
            /* Adjusted padding */
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .stat-item:last-child {
            margin-bottom: 0;
            /* Remove margin for last item */
        }


        /* Image Styling */
        .message-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
            /* Consistent rounding */
            margin-top: 10px;
            /* More space */
            cursor: pointer;
            transition: transform 0.2s ease-in-out, opacity 0.2s ease-in-out;
            /* Added opacity transition */
        }

        .message-image:hover {
            transform: scale(1.03);
            /* Slightly less intense scale */
            opacity: 0.9;
        }

        /* Image Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            /* Ensure on top */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.92);
            /* Darker overlay */
            justify-content: center;
            align-items: center;
            /* Add a subtle fade-in if JS toggles a class, otherwise this won't animate display:none */
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
            /* Rounded corners for modal image */
        }

        .close {
            position: absolute;
            top: 20px;
            /* More spacing */
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease-in-out;
        }

        .close:hover {
            color: #bbbbbb;
        }

        /* Leaderboard Name Links */
        .leaderboard .name {
            cursor: pointer;
            color: #64b5f6;
            /* Lighter, more inviting blue */
            text-decoration: none;
            /* Remove underline by default */
            transition: color 0.2s ease-in-out, text-decoration 0.2s ease-in-out;
        }

        .leaderboard .name:hover {
            color: #42a5f5;
            text-decoration: underline;
            /* Underline on hover */
        }

        /* Profile Activity Types */
        .activity-type {
            font-weight: bold;
            color: #4dd0e1;
            /* Cyan accent for activity type */
        }

        .activity-points {
            font-weight: bold;
            color: #fff;
            /* White for emphasis */
        }

        .activity-date {
            color: #a0a0a0;
            font-size: 0.9em;
        }

        /* View Profile Button */
        #view-profile-button {
            margin-top: 20px;
            background: #4CAF50;
            /* Green */
        }

        #view-profile-button:hover {
            background: #43a047;
            /* Darker green */
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        #view-profile-button:focus {
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.5);
        }


        /* Admin Styles */
        .admin-button {
            /* General class for admin action buttons */
            background: #e53935;
            /* Admin red */
        }

        .admin-button:hover {
            background: #d32f2f;
            /* Darker admin red */
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .admin-button:focus {
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.5);
        }


        .click-counter {
            font-size: 24px;
            margin: 20px 0;
            color: #f5f5f5;
        }

        /* Styles for the cleaner file input button */
        .file-upload-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            width: 100%;
            max-width: 300px;
            margin: 5px 0;
        }

        .hidden-file-input {
            display: none;
        }

        .custom-file-upload-button {
            display: inline-block;
            padding: 12px 20px;
            border-radius: 8px;
            /* Consistent rounding */
            border: 1px solid #1976D2;
            background: transparent;
            /* Transparent background for outline style */
            color: #64b5f6;
            /* Accent color text */
            font-size: 16px;
            font-weight: normal;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, border-color 0.2s ease-in-out, transform 0.2s ease-in-out;
            text-align: center;
            width: 100%;
        }

        .custom-file-upload-button:hover {
            background: rgba(25, 118, 210, 0.1);
            /* Subtle background on hover */
            border-color: #42a5f5;
            color: #42a5f5;
            transform: translateY(-1px);
            /* Subtle lift */
        }

        .custom-file-upload-button:focus {
            outline: none;
            border-color: #1565C0;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.4);
            color: #1565C0;
        }


        .file-name-display {
            font-size: 14px;
            color: #a0a0a0;
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        /* Scrollbar Styling (WebKit) */
        ::-webkit-scrollbar {
            width: 10px;
            /* Slightly wider for easier grabbing */
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #222;
            /* Darker track */
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 10px;
            border: 2px solid #222;
            /* Creates a "padding" effect */
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /* Responsive Design */
        @media (max-width: 500px) {
            body {
                padding: 10px;
                /* Less padding on small screens */
            }

            .container {
                padding: 20px;
                /* Adjust container padding */
            }

            .chat-container {
                height: 350px;
                padding: 15px;
            }

            .rules-content {
                padding: 15px;
                font-size: 16px;
            }

            .leaderboard li {
                padding: 12px;
                font-size: 16px;
            }

            /* Profile stats already column, so this specific media query might not change much for it
               but keeping it for other potential adjustments if the container max-width were larger. */
            .profile-stats-container {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <div id="imageModal" class="modal">
        <span class="close">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <div class="container">
        <div id="password-panel" class="panel">
            <h1>MCC Fitness Leaderboard</h1>
            <div class="form-group button-group"> <button id="signup-button">New User Signup</button>
                <button id="existing-login-button">Existing User Login</button>
            </div>
        </div>

        <div id="signup-panel" class="panel hidden">
            <h2>Sign Up</h2>
            <input type="text" id="name-input" placeholder="Username">
            <input type="password" id="password-input" placeholder="Password">
            <input type="password" id="confirm-password-input" placeholder="Confirm Password">
            <p id="signup-error-message" class="error"></p>
            <div class="button-group">
                <button id="submit-signup-button">Sign Up</button>
                <button class="back-home">Back</button>
            </div>
        </div>

        <div id="user-login-panel" class="panel hidden">
            <h2>User Login</h2>
            <input type="text" id="login-name-input" placeholder="Username">
            <input type="password" id="login-user-password-input" placeholder="Password">
            <p id="user-login-error-message" class="error"></p>
            <div class="button-group">
                <button id="submit-user-login-button">Login</button>
                <button class="back-home">Back</button>
            </div>
        </div>

        <div id="menu-panel" class="panel hidden">
            <h2>Welcome, <span id="current-user-display"></span>!</h2>
            <div class="button-group vertical">
                <button id="rules-button">Rules</button>
                <button id="add-points-button">Add Workout</button>
                <button id="leaderboard-button">Leaderboards</button>
                <button id="chat-button">Group Chat</button>
                <button id="view-profile-button">View My Profile</button>
                <button class="back-home">Logout</button> </div>
        </div>

        <div id="leaderboard-menu-panel" class="panel hidden">
            <h2>Leaderboards</h2>
            <div class="button-group vertical">
                <button id="all-workouts-button">All Workouts Leaderboard</button>
                <button id="erging-button">Erging Leaderboard</button>
                <button id="running-button">Running Leaderboard</button>
                <button id="biking-button">Biking Leaderboard</button>
                <button id="swimming-button">Swimming Leaderboard</button>
                <button class="back-to-menu">Back</button>
            </div>
        </div>

        <div id="all-workouts-panel" class="panel hidden">
            <h2>All Workouts Leaderboard</h2>
            <ul id="all-workouts-list" class="leaderboard"></ul>
            <div class="button-group">
                <button class="back-to-leaderboard">Back</button>
            </div>
        </div>

        <div id="erging-panel" class="panel hidden">
            <h2>Erging Leaderboard</h2>
            <ul id="erging-list" class="leaderboard"></ul>
            <div class="button-group">
                <button class="back-to-leaderboard">Back</button>
            </div>
        </div>

        <div id="running-panel" class="panel hidden">
            <h2>Running Leaderboard</h2>
            <ul id="running-list" class="leaderboard"></ul>
            <div class="button-group">
                <button class="back-to-leaderboard">Back</button>
            </div>
        </div>

        <div id="biking-panel" class="panel hidden">
            <h2>Biking Leaderboard</h2>
            <ul id="biking-list" class="leaderboard"></ul>
            <div class="button-group">
                <button class="back-to-leaderboard">Back</button>
            </div>
        </div>

        <div id="swimming-panel" class="panel hidden">
            <h2>Swimming Leaderboard</h2>
            <ul id="swimming-list" class="leaderboard"></ul>
            <div class="button-group">
                <button class="back-to-leaderboard">Back</button>
            </div>
        </div>

        <div id="rules-panel" class="panel hidden">
            <h2>Competition Rules</h2>
            <div class="rules-content">
                <p>1 Meter Erg = 1 Point</p>
                <p>300 Meter Swim = 1000 points</p>
                <p>1 Mile Run = 1000 Points</p>
                <p>1 Mile Bike = 500 Points</p>
                <p class="note">More will be added soon!</p>
            </div>
            <div class="button-group">
                <button class="back-to-menu">Back to Menu</button>
            </div>
        </div>

        <div id="points-menu" class="panel hidden">
            <h2>Add Workout</h2>
            <select id="activity-select">
                <option value="">Select Activity</option>
                <option value="Erg">Erging</option>
                <option value="Run">Running</option>
                <option value="Bike">Biking</option>
                <option value="Swim">Swimming</option>
            </select>
            <input type="number" id="points-input" placeholder="Points">
            <div class="file-upload-wrapper">
                <input type="file" id="photo-upload" accept="image/*" class="hidden-file-input">
                <label for="photo-upload" class="custom-file-upload-button">Choose Photo</label>
                <span id="file-name-display" class="file-name-display">No file chosen</span>
            </div>
            <div class="button-group">
                <button id="confirm-points-button">Submit</button>
                <button class="back-to-menu">Cancel</button> </div>
        </div>

        <div id="chat-panel" class="panel hidden">
            <h2>Group Chat</h2>
            <div class="chat-container">
                <ul id="chat-messages"></ul>
            </div>
            <div class="chat-input-container">
                <textarea id="chat-input" placeholder="Type your message here..." rows="3"></textarea> <button
                    id="send-button">Send</button>
            </div>
            <div class="button-group" style="margin-top: 15px;"> <button class="back-to-menu">Back to Menu</button>
            </div>
        </div>

        <div id="profile-panel" class="panel hidden">
            <div class="profile-container">
                <div class="profile-header">
                    <h2 id="profile-username">Username</h2>
                    <p>Total Points: <span id="profile-total-points">0</span></p>
                </div>

                <div class="profile-stats-container">
                    <div class="stat-box">
                        <h3>Highest Scores</h3>
                        <div id="highest-scores">
                        </div>
                    </div>

                    <div class="stat-box">
                        <h3>Recent Activities</h3>
                        <div id="recent-activities">
                        </div>
                    </div>

                    <div class="stat-box">
                        <h3>Activity Totals</h3>
                        <div id="activity-totals">
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="back-to-menu">Back to Menu</button>
                </div>
            </div>
        </div>

        <div id="admin-password-panel" class="panel hidden">
            <h2>Admin Access</h2>
            <input type="password" id="admin-password-input" placeholder="Enter Admin Password">
            <p id="admin-error-message" class="error"></p>
            <div class="button-group">
                <button id="submit-admin-password-button">Submit</button>
                <button class="back-to-menu">Back</button>
            </div>
        </div>

        <div id="admin-points-panel" class="panel hidden">
            <h2>Admin Points Editor</h2>
            <input type="text" id="admin-username-input" placeholder="Username">
            <input type="number" id="admin-points-input" placeholder="Points to add/subtract">
            <div class="button-group">
                <button id="admin-add-points-button">Add Points</button>
                <button id="admin-subtract-points-button" class="admin-button">Subtract Points</button> <button
                    class="back-to-menu">Back to Menu</button>
            </div>
        </div>

        <div id="super-admin-password-panel" class="panel hidden">
            <h2>Super Admin Access</h2>
            <input type="password" id="super-admin-password-input" placeholder="Enter Super Admin Password">
            <p id="super-admin-error-message" class="error"></p>
            <div class="button-group">
                <button id="submit-super-admin-password-button">Submit</button>
                <button class="back-to-menu">Back</button>
            </div>
        </div>

        <div id="super-admin-panel" class="panel hidden">
            <h2>Super Admin Controls</h2>
            <div class="click-counter">Clicks: <span id="click-count">0</span>/100</div>
            <div class="button-group vertical">
                <button id="wipe-confirm-button" class="hidden admin-button">Wipe All Points</button>
                <button id="undo-wipe-button" class="hidden">Undo Wipe (Disabled for Cloud)</button>
                <button id="click-button">Click Me</button>
                <button class="back-to-menu">Back to Menu</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            addDoc, 
            collection, 
            query, 
            where, 
            getDocs, 
            orderBy, 
            Timestamp, 
            updateDoc, 
            arrayUnion,
            onSnapshot,
            writeBatch,
            runTransaction
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDbL_-yIxKgL_6lu0TOWZpGuF3KeT7iluo", 
            authDomain: "mcc-summer-leaderboard.firebaseapp.com",
            projectId: "mcc-summer-leaderboard",
            storageBucket: "mcc-summer-leaderboard.firebasestorage.app",
            messagingSenderId: "376614411221",
            appId: "1:376614411221:web:9afe27edc84cf5de3b7b5c",
            measurementId: "G-SKPNS56ZDN"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- Main App Logic ---
        let currentFirebaseUser = null; 
        let currentAppUsername = null;  
        let clickCount = parseInt(localStorage.getItem('clickCount')) || 0;
        let typedWord = '';
        let unsubscribeChat = null; 

        function show(panelId) {
            document.querySelectorAll('.panel').forEach(p => p.classList.add('hidden'));
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.classList.remove('hidden');
            }
            if (panelId === 'chat-panel' && currentFirebaseUser) {
                renderMessages(); 
            } else if (unsubscribeChat) {
                unsubscribeChat(); 
                unsubscribeChat = null;
            }
        }
        
        const modal = document.getElementById("imageModal");
        const modalImg = document.getElementById("modalImage");
        const spanClose = document.getElementsByClassName("close")[0];

        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('message-image')) {
                modal.style.display = "flex";
                modalImg.src = e.target.src;
            }
        });
        if(spanClose) { 
            spanClose.onclick = function () {
                modal.style.display = "none";
            }
        }
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentFirebaseUser = user;
                const userRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userRef);
                if (docSnap.exists()) {
                    currentAppUsername = docSnap.data().username;
                    document.getElementById('current-user-display').textContent = currentAppUsername;
                    show('menu-panel');
                    updateAllLeaderboards();
                } else {
                    console.error("User data not found in Firestore for UID:", user.uid);
                    await signOut(auth); 
                }
            } else {
                currentFirebaseUser = null;
                currentAppUsername = null;
                if (unsubscribeChat) {
                    unsubscribeChat();
                    unsubscribeChat = null;
                }
                show('password-panel');
            }
        });

        function updateAllLeaderboards() {
            if (!currentFirebaseUser) return; 
            updateLeaderboard('all-workouts-list', 'total');
            updateLeaderboard('erging-list', 'Erg');
            updateLeaderboard('running-list', 'Run');
            updateLeaderboard('biking-list', 'Bike');
            updateLeaderboard('swimming-list', 'Swim');
        }

        async function updateLeaderboard(listId, activityType) {
            const usersRef = collection(db, "users");
            const querySnapshot = await getDocs(usersRef);
            let leaderboardData = [];

            querySnapshot.forEach((docSnap) => {
                const userData = docSnap.data();
                const userName = userData.username;
                let points = 0;

                if (userData.activities && Array.isArray(userData.activities)) {
                    if (activityType === 'total') {
                        points = userData.activities.reduce((sum, a) => sum + (a.points || 0), 0);
                    } else {
                        points = userData.activities
                            .filter(a => a.activity === activityType)
                            .reduce((sum, a) => sum + (a.points || 0), 0);
                    }
                }
                if (points > 0 || activityType === 'total') { 
                     leaderboardData.push({ name: userName, points, uid: docSnap.id });
                }
            });

            leaderboardData.sort((a, b) => b.points - a.points);

            const list = document.getElementById(listId);
            if (!list) return;
            list.innerHTML = '';

            leaderboardData.forEach((user, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="name" data-username="${user.name}" data-uid="${user.uid}">${user.name}</span>
                    <span class="points">${user.points} pts</span>
                `;
                if (index === 0) li.classList.add('gold');
                else if (index === 1) li.classList.add('silver');
                else if (index === 2) li.classList.add('bronze');
                list.appendChild(li);
            });

            document.querySelectorAll(`#${listId} .name`).forEach(el => {
                el.addEventListener('click', (e) => {
                    const username = e.target.getAttribute('data-username');
                    const userUID = e.target.getAttribute('data-uid');
                    showUserProfile(userUID, username);
                });
            });
        }
        
        async function showUserProfile(userUID, usernameToDisplay) {
            const userRef = doc(db, "users", userUID);
            const docSnap = await getDoc(userRef);

            if (!docSnap.exists()) {
                console.error("User profile not found for UID:", userUID);
                alert("Could not load user profile.");
                return;
            }

            const user = docSnap.data();
            const displayName = usernameToDisplay || user.username;

            document.getElementById('profile-username').textContent = displayName;

            const activities = user.activities || [];
            const totalPoints = activities.reduce((sum, a) => sum + (a.points || 0), 0);
            document.getElementById('profile-total-points').textContent = totalPoints;

            const highestPoints = {};
            const totalsByActivity = {};
            const allActivityTypes = ['Erg', 'Run', 'Bike', 'Swim']; 

            allActivityTypes.forEach(activity => {
                highestPoints[activity] = 0;
                totalsByActivity[activity] = 0;
            });

            activities.forEach(workout => {
                const activityName = workout.activity || 'Unknown';
                if (!highestPoints[activityName] && activityName !== 'Admin Adjust') highestPoints[activityName] = 0; 
                if (!totalsByActivity[activityName]) totalsByActivity[activityName] = 0; 

                if (workout.points > highestPoints[activityName] && activityName !== 'Admin Adjust') {
                    highestPoints[activityName] = workout.points;
                }
                totalsByActivity[activityName] += workout.points;
            });

            const highestScoresContainer = document.getElementById('highest-scores');
            highestScoresContainer.innerHTML = allActivityTypes.filter(act => act !== 'Admin Adjust').map(act => `
                <div class="stat-item">
                    <span class="activity-type">${act}:</span>
                    <span class="activity-points">${highestPoints[act] || 0} pts</span>
                </div>
            `).join('');

            const recentActivitiesContainer = document.getElementById('recent-activities');
            if (activities.length > 0) {
                recentActivitiesContainer.innerHTML = activities
                    .slice()
                    .sort((a, b) => (b.date && a.date) ? b.date.toMillis() - a.date.toMillis() : 0)
                    .slice(0, 10)
                    .map(workout => `
                    <div class="stat-item">
                        <div>
                            <span class="activity-type">${workout.activity}:</span>
                            <span class="activity-points">${workout.points} pts</span>
                        </div>
                        <div class="activity-date">${workout.date ? workout.date.toDate().toLocaleString() : 'N/A'}</div>
                        ${workout.image ? `<img src="${workout.image}" class="message-image">` : ''}
                    </div>
                `).join('');
            } else {
                recentActivitiesContainer.innerHTML = '<div class="stat-item">No activities yet</div>';
            }

            const activityTotalsContainer = document.getElementById('activity-totals');
            activityTotalsContainer.innerHTML = allActivityTypes.map(act => `
                <div class="stat-item">
                    <span class="activity-type">${act}:</span>
                    <span class="activity-points">${totalsByActivity[act] || 0} pts</span>
                </div>
            `).join('');

            show('profile-panel');
        }

        function renderMessages() {
            if (unsubscribeChat) { 
                unsubscribeChat();
            }
            const ul = document.getElementById('chat-messages');
            if (!ul) return;

            const messagesRef = collection(db, "messages");
            const qMessages = query(messagesRef, orderBy("time", "asc")); 

            unsubscribeChat = onSnapshot(qMessages, (querySnapshot) => {
                ul.innerHTML = ''; 
                querySnapshot.forEach((docSnap) => {
                    const m = docSnap.data();
                    const li = document.createElement('li');
                    const content = document.createElement('div');
                    content.className = 'message-content';
                    const header = document.createElement('div');
                    header.className = 'message-header';
                    header.innerHTML = `
                        <span class="message-sender">${m.user}</span>
                        <span class="message-time">${m.time ? m.time.toDate().toLocaleString() : 'N/A'}</span>
                    `;
                    content.appendChild(header);
                    const body = document.createElement('div');
                    body.className = 'message-body';
                    if (m.text) {
                        body.textContent = m.text;
                    } else if (m.activity) {
                        body.innerHTML = `Added <strong>${m.points} points</strong> from <strong>${m.activity}</strong>`;
                    }
                    content.appendChild(body);
                    if (m.image) {
                        const img = document.createElement('img');
                        img.src = m.image;
                        img.className = 'message-image';
                        content.appendChild(img);
                    }
                    li.appendChild(content);
                    ul.appendChild(li);
                });
                const chatContainer = document.querySelector('.chat-container');
                if (chatContainer) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }, (error) => {
                console.error("Error fetching chat messages: ", error);
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('signup-button').addEventListener('click', () => show('signup-panel'));
            document.getElementById('existing-login-button').addEventListener('click', () => show('user-login-panel'));

            document.querySelectorAll('.back-home').forEach(btn => {
                btn.addEventListener('click', async () => {
                    try {
                        if (auth.currentUser) { 
                            await signOut(auth);
                        } else {
                            show('password-panel');
                        }
                    } catch (error) {
                        console.error("Sign out error / .back-home error:", error);
                        show('password-panel');
                    }
                });
            });

            document.querySelectorAll('.back-to-menu').forEach(btn => {
                btn.addEventListener('click', () => show('menu-panel'));
            });

            document.querySelectorAll('.back-to-leaderboard').forEach(btn => {
                btn.addEventListener('click', () => show('leaderboard-menu-panel'));
            });

            document.getElementById('rules-button').addEventListener('click', () => show('rules-panel'));
            document.getElementById('add-points-button').addEventListener('click', () => show('points-menu'));
            document.getElementById('leaderboard-button').addEventListener('click', () => {
                updateAllLeaderboards();
                show('leaderboard-menu-panel');
            });
            document.getElementById('chat-button').addEventListener('click', () => show('chat-panel'));
            document.getElementById('view-profile-button').addEventListener('click', () => {
                if (currentFirebaseUser && currentAppUsername) {
                    showUserProfile(currentFirebaseUser.uid, currentAppUsername);
                }
            });

            document.getElementById('all-workouts-button').addEventListener('click', () => { updateLeaderboard('all-workouts-list', 'total'); show('all-workouts-panel'); });
            document.getElementById('erging-button').addEventListener('click', () => { updateLeaderboard('erging-list', 'Erg'); show('erging-panel'); });
            document.getElementById('running-button').addEventListener('click', () => { updateLeaderboard('running-list', 'Run'); show('running-panel'); });
            document.getElementById('biking-button').addEventListener('click', () => { updateLeaderboard('biking-list', 'Bike'); show('biking-panel'); });
            document.getElementById('swimming-button').addEventListener('click', () => { updateLeaderboard('swimming-list', 'Swim'); show('swimming-panel'); });

            document.getElementById('submit-signup-button').addEventListener('click', async () => {
                const name = document.getElementById('name-input').value.trim();
                const pw = document.getElementById('password-input').value;
                const confirmPw = document.getElementById('confirm-password-input').value;
                const signupError = document.getElementById('signup-error-message');
                signupError.textContent = '';

                if (!name || !pw) { signupError.textContent = "Please fill all fields"; return; }
                if (pw !== confirmPw) { signupError.textContent = "Passwords don't match"; return; }
                if (pw.length < 6) { signupError.textContent = "Password should be at least 6 characters"; return; }

                const usersRefTest = collection(db, "users");
                const qTest = query(usersRefTest, where("username", "==", name));
                const querySnapshotTest = await getDocs(qTest);
                if (!querySnapshotTest.empty) { signupError.textContent = "Username already exists"; return; }
                
                const email = `${name.replace(/\s+/g, '_').toLowerCase()}@gmail.com`; 

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, pw);
                    await setDoc(doc(db, "users", userCredential.user.uid), {
                        username: name,
                        activities: [],
                        createdAt: Timestamp.now()
                    });
                } catch (error) {
                    signupError.textContent = error.message.includes("email-already-in-use") ? "Username (or derived email) already taken." : "Signup failed: " + error.message;
                    console.error("Signup error:", error);
                }
            });

            document.getElementById('submit-user-login-button').addEventListener('click', async () => {
                const name = document.getElementById('login-name-input').value.trim();
                const pw = document.getElementById('login-user-password-input').value;
                const loginError = document.getElementById('user-login-error-message');
                loginError.textContent = '';

                if (!name || !pw) { loginError.textContent = "Please enter username and password."; return; }
                
                const email = `${name.replace(/\s+/g, '_').toLowerCase()}@gmail.com`;

                try {
                    await signInWithEmailAndPassword(auth, email, pw);
                } catch (error) {
                    loginError.textContent = "Invalid username or password.";
                    console.error("Login error:", error);
                }
            });
            
            const photoUploadInput = document.getElementById('photo-upload');
            const fileNameDisplay = document.getElementById('file-name-display');
            if (photoUploadInput && fileNameDisplay) {
                photoUploadInput.addEventListener('change', function() {
                    if (this.files && this.files.length > 0) {
                        fileNameDisplay.textContent = this.files[0].name;
                    } else {
                        fileNameDisplay.textContent = 'No file chosen';
                    }
                });
            }

            // MODIFIED: Add Workout (confirm points button)
            document.getElementById('confirm-points-button').addEventListener('click', async () => {
                const confirmButton = document.getElementById('confirm-points-button');
                const pointsInput = document.getElementById('points-input');
                const activitySelect = document.getElementById('activity-select');
                const photoUpload = document.getElementById('photo-upload');
                const currentFileNameDisplay = document.getElementById('file-name-display'); // Use local const

                if (!currentFirebaseUser) { 
                    alert("Please log in first."); 
                    return; 
                }

                const points = parseInt(pointsInput.value);
                const activity = activitySelect.value;
                const file = photoUpload.files[0];

                if (isNaN(points) || points <= 0 || !activity) { 
                    alert("Please select an activity and enter valid positive points"); 
                    return; 
                }

                confirmButton.disabled = true;
                confirmButton.textContent = 'Submitting...';

                try {
                    let imageUrl = null;
                    if (file) {
                        try {
                            const storageRef = ref(storage, `workout_images/${currentFirebaseUser.uid}/${Date.now()}_${file.name}`);
                            const snapshot = await uploadBytes(storageRef, file);
                            imageUrl = await getDownloadURL(snapshot.ref);
                        } catch (uploadError) {
                            console.error("Error uploading image: ", uploadError);
                            alert("Failed to upload image. Workout will be added without it.");
                            // Image upload failed, but we proceed to add workout data without image
                        }
                    }

                    const workoutData = { activity, points, date: Timestamp.now(), image: imageUrl };
                    const userRef = doc(db, "users", currentFirebaseUser.uid);

                    await updateDoc(userRef, { activities: arrayUnion(workoutData) });
                    await addDoc(collection(db, "messages"), {
                        userId: currentFirebaseUser.uid,
                        user: currentAppUsername,
                        activity: workoutData.activity,
                        points: workoutData.points,
                        image: workoutData.image,
                        time: Timestamp.now()
                    });

                    updateAllLeaderboards();
                    show('menu-panel');
                    pointsInput.value = '';
                    activitySelect.value = '';
                    photoUpload.value = null; 
                    if (currentFileNameDisplay) currentFileNameDisplay.textContent = 'No file chosen';
                    // alert("Workout added successfully!"); // Optional success alert

                } catch (error) {
                    console.error("Error adding workout: ", error);
                    alert("Failed to add workout. Please try again.");
                } finally {
                    confirmButton.disabled = false;
                    confirmButton.textContent = 'Submit';
                }
            });


            document.getElementById('send-button').addEventListener('click', async () => {
                const text = document.getElementById('chat-input').value.trim();
                if (!text || !currentFirebaseUser || !currentAppUsername) return;

                try {
                    await addDoc(collection(db, "messages"), {
                        userId: currentFirebaseUser.uid,
                        user: currentAppUsername,
                        text: text,
                        time: Timestamp.now()
                    });
                    document.getElementById('chat-input').value = '';
                } catch (error) {
                    console.error("Error sending message: ", error);
                    alert("Failed to send message.");
                }
            });
            
            document.getElementById('chat-input')?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    document.getElementById('send-button').click();
                }
            });

            document.addEventListener('keydown', (e) => {
                const currentPanel = document.querySelector('.panel:not(.hidden)');
                if (!currentPanel || (currentPanel.id !== 'password-panel' && currentPanel.id !== 'menu-panel' && currentPanel.id !== 'admin-points-panel')) {
                    typedWord = ''; 
                    return;
                }
                typedWord += e.key.toLowerCase();
                if (typedWord.includes('awesome')) {
                    typedWord = '';
                    if (currentPanel.id === 'password-panel' || currentPanel.id === 'menu-panel') show('admin-password-panel');
                    else if (currentPanel.id === 'admin-points-panel') show('super-admin-password-panel');
                }
                if (typedWord.length > 10) typedWord = typedWord.slice(-10);
            });

            document.getElementById('submit-admin-password-button').addEventListener('click', () => {
                const password = document.getElementById('admin-password-input').value;
                if (password === 'McleanCrew2025!') { 
                    document.getElementById('admin-error-message').textContent = '';
                    show('admin-points-panel');
                } else {
                    document.getElementById('admin-error-message').textContent = 'Incorrect password';
                }
                document.getElementById('admin-password-input').value = '';
            });
            
            async function modifyUserPoints(add) {
                const usernameToEdit = document.getElementById('admin-username-input').value.trim();
                let points = parseInt(document.getElementById('admin-points-input').value);
                if (!usernameToEdit || isNaN(points) || points === 0) { alert('Valid username and non-zero points required'); return; }

                if (!add) points = -points; 

                const usersRef = collection(db, "users");
                const q = query(usersRef, where("username", "==", usernameToEdit));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) { alert(`User ${usernameToEdit} not found.`); return; }
                const userDocSnap = querySnapshot.docs[0];
                try {
                    await updateDoc(doc(db, "users", userDocSnap.id), {
                        activities: arrayUnion({ activity: 'Admin Adjust', points: points, date: Timestamp.now() })
                    });
                    updateAllLeaderboards();
                    alert(`${add ? 'Added' : 'Subtracted'} ${Math.abs(points)} points ${add ? 'to' : 'from'} ${usernameToEdit}`);
                     document.getElementById('admin-username-input').value = '';
                     document.getElementById('admin-points-input').value = '';
                } catch (error) { console.error(`Admin ${add ? 'add' : 'subtract'} points error:`, error); alert("Error modifying points."); }
            }

            document.getElementById('admin-add-points-button').addEventListener('click', () => modifyUserPoints(true));
            document.getElementById('admin-subtract-points-button').addEventListener('click', () => modifyUserPoints(false));


            document.getElementById('submit-super-admin-password-button').addEventListener('click', () => {
                const password = document.getElementById('super-admin-password-input').value;
                if (password === 'LukeHoffman2006!') { 
                    document.getElementById('super-admin-error-message').textContent = '';
                    show('super-admin-panel');
                    document.getElementById('click-count').textContent = clickCount;
                } else {
                    document.getElementById('super-admin-error-message').textContent = 'Incorrect password';
                }
                document.getElementById('super-admin-password-input').value = '';
            });

            document.getElementById('click-button').addEventListener('click', () => {
                clickCount++;
                document.getElementById('click-count').textContent = clickCount;
                localStorage.setItem('clickCount', clickCount.toString()); 
                if (clickCount >= 100) {
                    document.getElementById('wipe-confirm-button').classList.remove('hidden');
                }
            });
            
            document.getElementById('wipe-confirm-button').addEventListener('click', async () => {
                if (confirm('Are you sure you want to wipe ALL points for ALL users from Firestore? This action is hard to reverse!')) {
                    const usersRef = collection(db, "users");
                    try {
                        const querySnapshot = await getDocs(usersRef);
                        const batch = writeBatch(db);
                        querySnapshot.forEach((docSnap) => {
                            batch.update(doc(db, "users", docSnap.id), { activities: [] });
                        });
                        await batch.commit();
                        updateAllLeaderboards();
                        alert('All points have been wiped from Firestore!');
                        document.getElementById('undo-wipe-button').classList.add('hidden'); 
                        clickCount = 0; 
                        localStorage.setItem('clickCount', clickCount.toString());
                        document.getElementById('click-count').textContent = clickCount;
                        document.getElementById('wipe-confirm-button').classList.add('hidden');

                    } catch (error) {
                        console.error("Error wiping points: ", error);
                        alert("Failed to wipe points from Firestore.");
                    }
                }
            });

            document.getElementById('undo-wipe-button').addEventListener('click', () => {
                alert('Client-side undo is not available for cloud data. Please use Firebase backups if needed.');
            });
            
             if (!currentFirebaseUser) { 
                show('password-panel');
             }
        });
    </script>
</body>

</html>