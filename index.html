<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness Leaderboard</title>
    <style>
        /* Dark Theme with Centered Content */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 500px;
            background: #1e1e1e;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            padding: 25px;
            text-align: center;
        }

        h1,
        h2,
        h3 {
            color: #ffffff;
            margin-top: 0;
        }

        /* Panel System */
        .panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }

        .hidden {
            display: none;
        }

        /* Leaderboard Styles */
        .leaderboard {
            list-style: none;
            padding: 0;
            width: 100%;
        }

        .leaderboard li {
            padding: 15px;
            margin: 10px 0;
            background: #2d2d2d;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            font-size: 18px;
        }

        .leaderboard li.gold {
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.3) 0%, #2d2d2d 30%);
            border-left: 5px solid #D4AF37;
        }

        .leaderboard li.silver {
            background: linear-gradient(90deg, rgba(192, 192, 192, 0.3) 0%, #2d2d2d 30%);
            border-left: 5px solid #C0C0C0;
        }

        .leaderboard li.bronze {
            background: linear-gradient(90deg, rgba(205, 127, 50, 0.3) 0%, #2d2d2d 30%);
            border-left: 5px solid #CD7F32;
        }

        /* Buttons */
        button {
            padding: 12px 20px;
            border-radius: 6px;
            border: none;
            background: #1976D2;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 300px;
            margin: 5px 0;
        }

        button:hover {
            background: #1565C0;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            align-items: center;
        }

        .button-group.vertical {
            gap: 15px;
        }

        /* Forms */
        input,
        select,
        textarea {
            width: 100%;
            max-width: 300px;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #333;
            background: #2d2d2d;
            color: #ffffff;
            font-size: 16px;
            margin: 5px 0;
        }

        .error {
            color: #f44336;
            margin: 10px 0;
        }

        /* Rules */
        .rules-content {
            text-align: center;
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 18px;
            line-height: 2;
            width: 100%;
        }

        .rules-content p {
            margin: 15px 0;
        }

        .note {
            font-style: italic;
            color: #aaa;
            margin-top: 25px !important;
        }

        /* Chat Styles */
        .chat-container {
            height: 400px;
            width: 100%;
            overflow-y: auto;
            border: 1px solid #333;
            border-radius: 8px;
            margin-bottom: 15px;
            background: #2d2d2d;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        #chat-messages {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            flex-grow: 1;
            list-style: none;
            padding: 0;
        }

        #chat-messages li {
            background: #3d3d3d;
            padding: 15px;
            border-radius: 8px;
            word-wrap: break-word;
            max-width: 100%;
            font-size: 16px;
        }

        .message-header {
            font-weight: bold;
            margin-bottom: 8px;
            color: #1976D2;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }

        .message-sender {
            font-weight: bold;
        }

        .message-time {
            color: #aaa;
            font-size: 0.8em;
        }

        .message-body {
            padding: 8px 0;
            font-size: 16px;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            width: 100%;
            align-items: flex-end;
        }

        #chat-input {
            flex: 1;
            min-height: 80px;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #333;
            background: #2d2d2d;
            color: #ffffff;
            font-size: 16px;
            resize: vertical;
            line-height: 1.5;
            max-height: 200px;
            overflow-y: auto;
        }

        #chat-input:focus {
            outline: none;
            border-color: #1976D2;
        }

        #send-button {
            height: 50px;
            width: 80px;
            padding: 0;
            margin: 0;
        }

        /* Profile View Styles */
        .profile-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .profile-header {
            text-align: center;
            padding: 20px;
            background: #2d2d2d;
            border-radius: 8px;
        }

        .profile-stats-container {
            display: flex;
            gap: 15px;
            width: 100%;
            flex-direction: column;
        }

        @media (min-width: 768px) {
            .profile-stats-container {
                flex-direction: row;
            }
        }

        .stat-box {
            flex: 1;
            background: #2d2d2d;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .stat-box h3 {
            margin-top: 0;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .stat-item {
            background: #3d3d3d;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        /* Image Styling */
        .message-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 4px;
            margin-top: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .message-image:hover {
            transform: scale(1.05);
        }

        /* Image Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Leaderboard Name Links */
        .leaderboard .name {
            cursor: pointer;
            color: #1976D2;
            text-decoration: underline;
        }

        .leaderboard .name:hover {
            color: #1565C0;
        }

        /* Profile Activity Types */
        .activity-type {
            font-weight: bold;
            color: #4CAF50;
        }

        .activity-points {
            font-weight: bold;
        }

        .activity-date {
            color: #aaa;
            font-size: 0.9em;
        }

        /* View Profile Button */
        #view-profile-button {
            margin-top: 20px;
            background: #4CAF50;
        }

        #view-profile-button:hover {
            background: #3e8e41;
        }

        /* Admin Styles */
        .admin-button {
            background: #f44336;
        }

        .admin-button:hover {
            background: #d32f2f;
        }

        .click-counter {
            font-size: 24px;
            margin: 20px 0;
        }

        /* Responsive Design */
        @media (max-width: 500px) {
            .container {
                padding: 15px;
            }

            .chat-container {
                height: 350px;
                padding: 15px;
            }

            .rules-content {
                padding: 15px;
                font-size: 16px;
            }

            .leaderboard li {
                padding: 12px;
                font-size: 16px;
            }

            .profile-stats-container {
                flex-direction: column;
            }
        }

        /* Styles for the cleaner file input button */
        .file-upload-wrapper {
            position: relative;
            /* For potential future absolute positioning of elements inside */
            display: flex;
            flex-direction: column;
            /* Stack button and file name */
            align-items: center;
            gap: 8px;
            /* Space between button and file name text */
            width: 100%;
            max-width: 300px;
            /* Match other inputs */
            margin: 5px 0;
            /* Match other inputs */
        }

        .hidden-file-input {
            display: none;
            /* Hide the default file input */
        }

        .custom-file-upload-button {
            display: inline-block;
            /* Allows padding and other block-like properties */
            padding: 12px 20px;
            border-radius: 6px;
            border: 1px solid #1976D2;
            /* Or use a background color */
            background: #2d2d2d;
            /* Darker background for contrast or match inputs */
            color: #1976D2;
            /* Text color, can be white if background is #1976D2 */
            font-size: 16px;
            font-weight: normal;
            /* Or bold if you prefer */
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            width: 100%;
            /* Make it full-width within its container */
            box-sizing: border-box;
            /* Ensure padding doesn't overflow width */
        }

        .custom-file-upload-button:hover {
            background: #3a3a3a;
            /* Slightly lighter on hover if background is dark */
            border-color: #1565C0;
            color: #1565C0;
            /* Or adjust hover text color */
        }

        .file-name-display {
            font-size: 14px;
            color: #aaa;
            /* Lighter text for the file name */
            margin-top: 5px;
            white-space: nowrap;
            /* Prevent wrapping */
            overflow: hidden;
            /* Hide overflow */
            text-overflow: ellipsis;
            /* Add ellipsis if text is too long */
            max-width: 100%;
            /* Ensure it doesn't overflow its container */
        }
    </style>
</head>

<body>
    <div id="imageModal" class="modal">
        <span class="close">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <div class="container">
        <div id="password-panel" class="panel">
            <h1>Fitness Leaderboard</h1>
            <div class="form-group">
                <button id="signup-button">New User Signup</button>
                <button id="existing-login-button">Existing User Login</button>
            </div>
        </div>

        <div id="signup-panel" class="panel hidden">
            <h2>Sign Up</h2>
            <input type="text" id="name-input" placeholder="Username">
            <input type="password" id="password-input" placeholder="Password">
            <input type="password" id="confirm-password-input" placeholder="Confirm Password">
            <p id="signup-error-message" class="error"></p>
            <div class="button-group">
                <button id="submit-signup-button">Sign Up</button>
                <button class="back-home">Back</button>
            </div>
        </div>

        <div id="user-login-panel" class="panel hidden">
            <h2>User Login</h2>
            <input type="text" id="login-name-input" placeholder="Username">
            <input type="password" id="login-user-password-input" placeholder="Password">
            <p id="user-login-error-message" class="error"></p>
            <div class="button-group">
                <button id="submit-user-login-button">Login</button>
                <button class="back-home">Back</button>
            </div>
        </div>

        <div id="menu-panel" class="panel hidden">
            <h2>Welcome <span id="current-user-display"></span></h2>
            <div class="button-group vertical">
                <button id="rules-button">Rules</button>
                <button id="add-points-button">Add Workout</button>
                <button id="leaderboard-button">Leaderboards</button>
                <button id="chat-button">Group Chat</button>
                <button id="view-profile-button">View My Profile</button>
                <button class="back-home">Logout</button> </div>
        </div>

        <div id="leaderboard-menu-panel" class="panel hidden">
            <h2>Leaderboards</h2>
            <div class="button-group vertical">
                <button id="all-workouts-button">All Workouts Leaderboard</button>
                <button id="erging-button">Erging Leaderboard</button>
                <button id="running-button">Running Leaderboard</button>
                <button id="biking-button">Biking Leaderboard</button>
                <button id="swimming-button">Swimming Leaderboard</button>
                <button class="back-to-menu">Back</button>
            </div>
        </div>

        <div id="all-workouts-panel" class="panel hidden">
            <h2>All Workouts Leaderboard</h2>
            <ul id="all-workouts-list" class="leaderboard"></ul>
            <div class="button-group">
                <button class="back-to-leaderboard">Back</button>
            </div>
        </div>

        <div id="erging-panel" class="panel hidden">
            <h2>Erging Leaderboard</h2>
            <ul id="erging-list" class="leaderboard"></ul>
            <div class="button-group">
                <button class="back-to-leaderboard">Back</button>
            </div>
        </div>

        <div id="running-panel" class="panel hidden">
            <h2>Running Leaderboard</h2>
            <ul id="running-list" class="leaderboard"></ul>
            <div class="button-group">
                <button class="back-to-leaderboard">Back</button>
            </div>
        </div>

        <div id="biking-panel" class="panel hidden">
            <h2>Biking Leaderboard</h2>
            <ul id="biking-list" class="leaderboard"></ul>
            <div class="button-group">
                <button class="back-to-leaderboard">Back</button>
            </div>
        </div>

        <div id="swimming-panel" class="panel hidden">
            <h2>Swimming Leaderboard</h2>
            <ul id="swimming-list" class="leaderboard"></ul>
            <div class="button-group">
                <button class="back-to-leaderboard">Back</button>
            </div>
        </div>

        <div id="rules-panel" class="panel hidden">
            <h2>Competition Rules</h2>
            <div class="rules-content">
                <p>1 Meter Erg = 1 Point</p>
                <p>300 Meter Swim = 1000 points</p>
                <p>1 Mile Run = 1000 Points</p>
                <p>1 Mile Bike = 500 Points</p>
                <p class="note">More will be added soon!</p>
            </div>
            <div class="button-group">
                <button class="back-to-menu">Back to Menu</button>
            </div>
        </div>

        <div id="points-menu" class="panel hidden">
            <h2>Add Workout</h2>
            <select id="activity-select">
                <option value="">Select Activity</option>
                <option value="Erg">Erging</option>
                <option value="Run">Running</option>
                <option value="Bike">Biking</option>
                <option value="Swim">Swimming</option>
            </select>
            <input type="number" id="points-input" placeholder="Points">
            <div class="file-upload-wrapper">
                <input type="file" id="photo-upload" accept="image/*" class="hidden-file-input">
                <label for="photo-upload" class="custom-file-upload-button">Choose Photo</label>
                <span id="file-name-display" class="file-name-display">No file chosen</span>
            </div>
            <div class="button-group">
                <button id="confirm-points-button">Submit</button>
                <button class="back-to-menu">Cancel</button>
            </div>
        </div>

        <div id="chat-panel" class="panel hidden">
            <h2>Group Chat</h2>
            <div class="chat-container">
                <ul id="chat-messages"></ul>
            </div>
            <div class="chat-input-container">
                <textarea id="chat-input" placeholder="Type your message here..." rows="4"></textarea>
                <button id="send-button">Send</button>
            </div>
            <div class="button-group">
                <button class="back-to-menu">Back to Menu</button>
            </div>
        </div>

        <div id="profile-panel" class="panel hidden">
            <div class="profile-container">
                <div class="profile-header">
                    <h2 id="profile-username">Username</h2>
                    <p>Total Points: <span id="profile-total-points">0</span></p>
                </div>

                <div class="profile-stats-container">
                    <div class="stat-box">
                        <h3>Highest Scores</h3>
                        <div id="highest-scores">
                        </div>
                    </div>

                    <div class="stat-box">
                        <h3>Recent Activities</h3>
                        <div id="recent-activities">
                        </div>
                    </div>

                    <div class="stat-box">
                        <h3>Activity <br>Totals</h3>
                        <div id="activity-totals">
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="back-to-menu">Back to Menu</button>
                </div>
            </div>
        </div>

        <div id="admin-password-panel" class="panel hidden">
            <h2>Admin Access</h2>
            <input type="password" id="admin-password-input" placeholder="Enter Admin Password">
            <p id="admin-error-message" class="error"></p>
            <div class="button-group">
                <button id="submit-admin-password-button">Submit</button>
                <button class="back-to-menu">Back</button>
            </div>
        </div>

        <div id="admin-points-panel" class="panel hidden">
            <h2>Admin Points Editor</h2>
            <input type="text" id="admin-username-input" placeholder="Username">
            <input type="number" id="admin-points-input" placeholder="Points to add/subtract">
            <div class="button-group">
                <button id="admin-add-points-button">Add Points</button>
                <button id="admin-subtract-points-button">Subtract Points</button>
                <button class="back-to-menu">Back to Menu</button>
            </div>
        </div>

        <div id="super-admin-password-panel" class="panel hidden">
            <h2>Super Admin Access</h2>
            <input type="password" id="super-admin-password-input" placeholder="Enter Super Admin Password">
            <p id="super-admin-error-message" class="error"></p>
            <div class="button-group">
                <button id="submit-super-admin-password-button">Submit</button>
                <button class="back-to-menu">Back</button>
            </div>
        </div>

        <div id="super-admin-panel" class="panel hidden">
            <h2>Super Admin Controls</h2>
            <div class="click-counter">Clicks: <span id="click-count">0</span>/100</div>
            <div class="button-group vertical">
                <button id="wipe-confirm-button" class="hidden admin-button">Wipe All Points</button>
                <button id="undo-wipe-button" class="hidden">Undo Wipe (Disabled for Cloud)</button>
                <button id="click-button">Click Me</button>
                <button class="back-to-menu">Back to Menu</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            addDoc, 
            collection, 
            query, 
            where, 
            getDocs, 
            orderBy, 
            Timestamp, 
            updateDoc, 
            arrayUnion,
            onSnapshot,
            writeBatch,
            runTransaction
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyDbL_-yIxKgL_6lu0TOWZpGuF3KeT7iluo", // Keep your actual API key
            authDomain: "mcc-summer-leaderboard.firebaseapp.com",
            projectId: "mcc-summer-leaderboard",
            storageBucket: "mcc-summer-leaderboard.firebasestorage.app",
            messagingSenderId: "376614411221",
            appId: "1:376614411221:web:9afe27edc84cf5de3b7b5c",
            measurementId: "G-SKPNS56ZDN"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- Main App Logic ---

        // Data Storage
        let currentFirebaseUser = null; // Firebase auth user object
        let currentAppUsername = null;  // Application-specific username
        let clickCount = parseInt(localStorage.getItem('clickCount')) || 0;
        let typedWord = '';
        let unsubscribeChat = null; // For chat listener

        // Panel Navigation
        function show(panelId) {
            document.querySelectorAll('.panel').forEach(p => p.classList.add('hidden'));
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.classList.remove('hidden');
            }
            if (panelId === 'chat-panel' && currentFirebaseUser) {
                renderMessages(); // Start listening for messages when chat panel is shown
            } else if (unsubscribeChat) {
                unsubscribeChat(); // Stop listening when navigating away from chat
                unsubscribeChat = null;
            }
        }
        
        // Image Modal functionality
        const modal = document.getElementById("imageModal");
        const modalImg = document.getElementById("modalImage");
        const spanClose = document.getElementsByClassName("close")[0];

        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('message-image')) {
                modal.style.display = "flex";
                modalImg.src = e.target.src;
            }
        });
        if(spanClose) { // Ensure spanClose exists before adding listener
            spanClose.onclick = function () {
                modal.style.display = "none";
            }
        }
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // Firebase Auth State Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentFirebaseUser = user;
                const userRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userRef);
                if (docSnap.exists()) {
                    currentAppUsername = docSnap.data().username;
                    document.getElementById('current-user-display').textContent = currentAppUsername;
                    show('menu-panel');
                    updateAllLeaderboards();
                } else {
                    console.error("User data not found in Firestore for UID:", user.uid);
                    await signOut(auth); // Log out if profile doesn't exist
                }
            } else {
                currentFirebaseUser = null;
                currentAppUsername = null;
                if (unsubscribeChat) {
                    unsubscribeChat();
                    unsubscribeChat = null;
                }
                show('password-panel');
            }
        });

        // Update all leaderboards
        function updateAllLeaderboards() {
            if (!currentFirebaseUser) return; // Don't update if not logged in
            updateLeaderboard('all-workouts-list', 'total');
            updateLeaderboard('erging-list', 'Erg');
            updateLeaderboard('running-list', 'Run');
            updateLeaderboard('biking-list', 'Bike');
            updateLeaderboard('swimming-list', 'Swim');
        }

        // Update specific leaderboard
        async function updateLeaderboard(listId, activityType) {
            const usersRef = collection(db, "users");
            // No specific query needed here, we process all users client-side for this example
            // For very large user bases, consider server-side aggregation or more specific queries.
            const querySnapshot = await getDocs(usersRef);
            let leaderboardData = [];

            querySnapshot.forEach((docSnap) => {
                const userData = docSnap.data();
                const userName = userData.username;
                let points = 0;

                if (userData.activities && Array.isArray(userData.activities)) {
                    if (activityType === 'total') {
                        points = userData.activities.reduce((sum, a) => sum + (a.points || 0), 0);
                    } else {
                        points = userData.activities
                            .filter(a => a.activity === activityType)
                            .reduce((sum, a) => sum + (a.points || 0), 0);
                    }
                }
                if (points > 0) {
                    leaderboardData.push({ name: userName, points, uid: docSnap.id });
                }
            });

            leaderboardData.sort((a, b) => b.points - a.points);

            const list = document.getElementById(listId);
            if (!list) return;
            list.innerHTML = '';

            leaderboardData.forEach((user, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="name" data-username="${user.name}" data-uid="${user.uid}">${user.name}</span>
                    <span class="points">${user.points} pts</span>
                `;
                if (index === 0) li.classList.add('gold');
                else if (index === 1) li.classList.add('silver');
                else if (index === 2) li.classList.add('bronze');
                list.appendChild(li);
            });

            document.querySelectorAll(`#${listId} .name`).forEach(el => {
                el.addEventListener('click', (e) => {
                    const username = e.target.getAttribute('data-username');
                    const userUID = e.target.getAttribute('data-uid');
                    showUserProfile(userUID, username);
                });
            });
        }
        
        // Show user profile
        async function showUserProfile(userUID, usernameToDisplay) {
            const userRef = doc(db, "users", userUID);
            const docSnap = await getDoc(userRef);

            if (!docSnap.exists()) {
                console.error("User profile not found for UID:", userUID);
                alert("Could not load user profile.");
                return;
            }

            const user = docSnap.data();
            const displayName = usernameToDisplay || user.username;

            document.getElementById('profile-username').textContent = displayName;

            const activities = user.activities || [];
            const totalPoints = activities.reduce((sum, a) => sum + (a.points || 0), 0);
            document.getElementById('profile-total-points').textContent = totalPoints;

            const highestPoints = {};
            const totalsByActivity = {};
            const allActivityTypes = ['Erg', 'Run', 'Bike', 'Swim'];

            allActivityTypes.forEach(activity => {
                highestPoints[activity] = 0;
                totalsByActivity[activity] = 0;
            });

            activities.forEach(workout => {
                const activityName = workout.activity || 'Unknown';
                if (!highestPoints[activityName]) highestPoints[activityName] = 0;
                if (!totalsByActivity[activityName]) totalsByActivity[activityName] = 0;

                if (workout.points > highestPoints[activityName]) {
                    highestPoints[activityName] = workout.points;
                }
                totalsByActivity[activityName] += workout.points;
            });

            const highestScoresContainer = document.getElementById('highest-scores');
            highestScoresContainer.innerHTML = allActivityTypes.map(act => `
                <div class="stat-item">
                    <span class="activity-type">${act}:</span>
                    <span class="activity-points">${highestPoints[act] || 0} pts</span>
                </div>
            `).join('');

            const recentActivitiesContainer = document.getElementById('recent-activities');
            if (activities.length > 0) {
                recentActivitiesContainer.innerHTML = activities
                    .slice()
                    .sort((a, b) => (b.date && a.date) ? b.date.toMillis() - a.date.toMillis() : 0)
                    .slice(0, 10)
                    .map(workout => `
                    <div class="stat-item">
                        <div>
                            <span class="activity-type">${workout.activity}:</span>
                            <span class="activity-points">${workout.points} pts</span>
                        </div>
                        <div class="activity-date">${workout.date ? workout.date.toDate().toLocaleString() : 'N/A'}</div>
                        ${workout.image ? `<img src="${workout.image}" class="message-image">` : ''}
                    </div>
                `).join('');
            } else {
                recentActivitiesContainer.innerHTML = '<div class="stat-item">No activities yet</div>';
            }

            const activityTotalsContainer = document.getElementById('activity-totals');
            activityTotalsContainer.innerHTML = allActivityTypes.map(act => `
                <div class="stat-item">
                    <span class="activity-type">${act}:</span>
                    <span class="activity-points">${totalsByActivity[act] || 0} pts</span>
                </div>
            `).join('');

            show('profile-panel');
        }

        // Render chat messages
        function renderMessages() {
            if (unsubscribeChat) { // If already listening, return or clear first
                unsubscribeChat();
            }
            const ul = document.getElementById('chat-messages');
            if (!ul) return;

            const messagesRef = collection(db, "messages");
            const qMessages = query(messagesRef, orderBy("time", "asc")); 

            unsubscribeChat = onSnapshot(qMessages, (querySnapshot) => {
                ul.innerHTML = ''; 
                querySnapshot.forEach((docSnap) => {
                    const m = docSnap.data();
                    const li = document.createElement('li');
                    const content = document.createElement('div');
                    content.className = 'message-content';
                    const header = document.createElement('div');
                    header.className = 'message-header';
                    header.innerHTML = `
                        <span class="message-sender">${m.user}</span>
                        <span class="message-time">${m.time ? m.time.toDate().toLocaleString() : 'N/A'}</span>
                    `;
                    content.appendChild(header);
                    const body = document.createElement('div');
                    body.className = 'message-body';
                    if (m.text) {
                        body.textContent = m.text;
                    } else if (m.activity) {
                        body.innerHTML = `Added <strong>${m.points} points</strong> from <strong>${m.activity}</strong>`;
                    }
                    content.appendChild(body);
                    if (m.image) {
                        const img = document.createElement('img');
                        img.src = m.image;
                        img.className = 'message-image';
                        content.appendChild(img);
                    }
                    li.appendChild(content);
                    ul.appendChild(li);
                });
                const chatContainer = document.querySelector('.chat-container');
                if (chatContainer) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }, (error) => {
                console.error("Error fetching chat messages: ", error);
            });
        }
        
        // DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            // Navigation
            document.getElementById('signup-button').addEventListener('click', () => show('signup-panel'));
            document.getElementById('existing-login-button').addEventListener('click', () => show('user-login-panel'));

            document.querySelectorAll('.back-home').forEach(btn => {
    btn.addEventListener('click', async () => {
        console.log(".back-home button clicked"); // For debugging
        try {
            if (auth.currentUser) { // Only attempt signOut if a user is actually logged in
                console.log("Attempting to sign out user:", auth.currentUser.uid);
                await signOut(auth);
                // onAuthStateChanged will then handle showing 'password-panel'
            } else {
                // If no user is logged in, onAuthStateChanged might not fire to change panel,
                // so explicitly show the password panel.
                console.log("No user to sign out, directly showing password-panel.");
                show('password-panel');
            }
        } catch (error) {
            console.error("Sign out error / .back-home error:", error);
            // Fallback in case of error during signout, still try to navigate
            show('password-panel');
        }
    });
});

            document.querySelectorAll('.back-to-menu').forEach(btn => {
                btn.addEventListener('click', () => show('menu-panel'));
            });

            document.querySelectorAll('.back-to-leaderboard').forEach(btn => {
                btn.addEventListener('click', () => show('leaderboard-menu-panel'));
            });

            // Menu buttons
            document.getElementById('rules-button').addEventListener('click', () => show('rules-panel'));
            document.getElementById('add-points-button').addEventListener('click', () => show('points-menu'));
            document.getElementById('leaderboard-button').addEventListener('click', () => {
                updateAllLeaderboards();
                show('leaderboard-menu-panel');
            });
            document.getElementById('chat-button').addEventListener('click', () => show('chat-panel'));
            document.getElementById('view-profile-button').addEventListener('click', () => {
                if (currentFirebaseUser && currentAppUsername) {
                    showUserProfile(currentFirebaseUser.uid, currentAppUsername);
                }
            });

            // Leaderboard menu buttons
            document.getElementById('all-workouts-button').addEventListener('click', () => { updateLeaderboard('all-workouts-list', 'total'); show('all-workouts-panel'); });
            document.getElementById('erging-button').addEventListener('click', () => { updateLeaderboard('erging-list', 'Erg'); show('erging-panel'); });
            document.getElementById('running-button').addEventListener('click', () => { updateLeaderboard('running-list', 'Run'); show('running-panel'); });
            document.getElementById('biking-button').addEventListener('click', () => { updateLeaderboard('biking-list', 'Bike'); show('biking-panel'); });
            document.getElementById('swimming-button').addEventListener('click', () => { updateLeaderboard('swimming-list', 'Swim'); show('swimming-panel'); });

            // User Signup
            document.getElementById('submit-signup-button').addEventListener('click', async () => {
                console.log("Submit signup button clicked!");
                const name = document.getElementById('name-input').value.trim();
                const pw = document.getElementById('password-input').value;
                const confirmPw = document.getElementById('confirm-password-input').value;
                const signupError = document.getElementById('signup-error-message');
                signupError.textContent = '';

                if (!name || !pw) { signupError.textContent = "Please fill all fields"; return; }
                if (pw !== confirmPw) { signupError.textContent = "Passwords don't match"; return; }

                const usersRefTest = collection(db, "users");
                const qTest = query(usersRefTest, where("username", "==", name));
                const querySnapshotTest = await getDocs(qTest);
                if (!querySnapshotTest.empty) { signupError.textContent = "Username already exists"; return; }
                
                const email = `${name.replace(/\s+/g, '_').toLowerCase()}@gmail.com`; 
                console.log("Generated username for Firebase Auth:", email); // <--- ADD THIS LINE

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, pw);
                    await setDoc(doc(db, "users", userCredential.user.uid), {
                        username: name,
                        activities: [],
                        createdAt: Timestamp.now()
                    });
                    // onAuthStateChanged handles showing the menu panel
                } catch (error) {
                    signupError.textContent = error.message.includes("email-already-in-use") ? "Username (or derived email) already taken." : "Signup failed: " + error.message;
                    console.error("Signup error:", error);
                }
            });

            // User Login
            document.getElementById('submit-user-login-button').addEventListener('click', async () => {
                const name = document.getElementById('login-name-input').value.trim();
                const pw = document.getElementById('login-user-password-input').value;
                const loginError = document.getElementById('user-login-error-message');
                loginError.textContent = '';

                if (!name || !pw) { loginError.textContent = "Please enter username and password."; return; }
                const email = `${name.replace(/\s+/g, '_').toLowerCase()}@gmail.com`;

                try {
                    await signInWithEmailAndPassword(auth, email, pw);
                    // onAuthStateChanged handles UI
                } catch (error) {
                    loginError.textContent = "Invalid username or password.";
                    console.error("Login error:", error);
                }
            });

            // Add Workout (confirm points button)
            document.getElementById('confirm-points-button').addEventListener('click', async () => {
                if (!currentFirebaseUser) { alert("Please log in first."); return; }

                const points = parseInt(document.getElementById('points-input').value);
                const activity = document.getElementById('activity-select').value;

                const photoUploadInput = document.getElementById('photo-upload');
                const fileNameDisplay = document.getElementById('file-name-display');

                if (photoUploadInput && fileNameDisplay) {
                    photoUploadInput.addEventListener('change', function() {
                        if (this.files && this.files.length > 0) {
                            fileNameDisplay.textContent = this.files[0].name;
                        } else {
                            fileNameDisplay.textContent = 'No file chosen';
                        }
                    });
                }
                const fileInput = document.getElementById('photo-upload');
                const file = fileInput.files[0];

                if (!points || points <= 0 || !activity) { alert("Please select an activity and enter valid points"); return; }

                let imageUrl = null;
                if (file) {
                    try {
                        const storageRef = ref(storage, `workout_images/${currentFirebaseUser.uid}/${Date.now()}_${file.name}`);
                        const snapshot = await uploadBytes(storageRef, file);
                        imageUrl = await getDownloadURL(snapshot.ref);
                    } catch (error) {
                        console.error("Error uploading image: ", error);
                        alert("Failed to upload image. Workout will be added without it.");
                    }
                }

                const workoutData = { activity, points, date: Timestamp.now(), image: imageUrl };
                const userRef = doc(db, "users", currentFirebaseUser.uid);

                try {
                    await updateDoc(userRef, { activities: arrayUnion(workoutData) });
                    await addDoc(collection(db, "messages"), {
                        userId: currentFirebaseUser.uid,
                        user: currentAppUsername,
                        activity: workoutData.activity,
                        points: workoutData.points,
                        image: workoutData.image,
                        time: Timestamp.now()
                    });
                    updateAllLeaderboards();
                    show('menu-panel');
                    document.getElementById('points-input').value = '';
                    document.getElementById('activity-select').value = '';
                    fileInput.value = null; // Reset file input
                } catch (error) {
                    console.error("Error adding workout: ", error);
                    alert("Failed to add workout.");
                }
            });

            // Chat Send Button
            document.getElementById('send-button').addEventListener('click', async () => {
                const text = document.getElementById('chat-input').value.trim();
                if (!text || !currentFirebaseUser || !currentAppUsername) return;

                try {
                    await addDoc(collection(db, "messages"), {
                        userId: currentFirebaseUser.uid,
                        user: currentAppUsername,
                        text: text,
                        time: Timestamp.now()
                    });
                    document.getElementById('chat-input').value = '';
                    // renderMessages updates via onSnapshot
                } catch (error) {
                    console.error("Error sending message: ", error);
                    alert("Failed to send message.");
                }
            });
            
            document.getElementById('chat-input')?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    document.getElementById('send-button').click();
                }
            });

            // Secret word detection
            document.addEventListener('keydown', (e) => {
                const currentPanel = document.querySelector('.panel:not(.hidden)');
                if (!currentPanel || (currentPanel.id !== 'password-panel' && currentPanel.id !== 'menu-panel' && currentPanel.id !== 'admin-points-panel')) {
                    typedWord = ''; // Reset if not on relevant panels
                    return;
                }
                typedWord += e.key.toLowerCase();
                if (typedWord.includes('awesome')) {
                    typedWord = '';
                    if (currentPanel.id === 'password-panel' || currentPanel.id === 'menu-panel') show('admin-password-panel');
                    else if (currentPanel.id === 'admin-points-panel') show('super-admin-password-panel');
                }
                if (typedWord.length > 10) typedWord = typedWord.slice(-10);
            });

            // Admin password submit
            document.getElementById('submit-admin-password-button').addEventListener('click', () => {
                const password = document.getElementById('admin-password-input').value;
                if (password === 'McleanCrew2025!') { // Keep your admin password
                    document.getElementById('admin-error-message').textContent = '';
                    show('admin-points-panel');
                } else {
                    document.getElementById('admin-error-message').textContent = 'Incorrect password';
                }
                document.getElementById('admin-password-input').value = '';
            });

            // Admin points management (add)
            document.getElementById('admin-add-points-button').addEventListener('click', async () => {
                const usernameToEdit = document.getElementById('admin-username-input').value.trim();
                const points = parseInt(document.getElementById('admin-points-input').value);
                if (!usernameToEdit || !points || points <= 0) { alert('Valid username and positive points required'); return; }

                const usersRef = collection(db, "users");
                const q = query(usersRef, where("username", "==", usernameToEdit));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) { alert(`User ${usernameToEdit} not found.`); return; }
                const userDocSnap = querySnapshot.docs[0];
                try {
                    await updateDoc(doc(db, "users", userDocSnap.id), {
                        activities: arrayUnion({ activity: 'Admin Adjust', points: points, date: Timestamp.now() })
                    });
                    updateAllLeaderboards();
                    alert(`Added ${points} points to ${usernameToEdit}`);
                } catch (error) { console.error("Admin add points error:", error); alert("Error adding points."); }
            });
            // Admin points management (subtract)
             document.getElementById('admin-subtract-points-button').addEventListener('click', async () => {
                const usernameToEdit = document.getElementById('admin-username-input').value.trim();
                const pointsToSubtract = parseInt(document.getElementById('admin-points-input').value);
                if (!usernameToEdit || !pointsToSubtract || pointsToSubtract <= 0) { alert('Valid username and positive points to subtract required'); return; }

                const usersRef = collection(db, "users");
                const q = query(usersRef, where("username", "==", usernameToEdit));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) { alert(`User ${usernameToEdit} not found.`); return; }
                const userDocSnap = querySnapshot.docs[0];
                try {
                    // Subtracting points by adding a negative value activity
                    await updateDoc(doc(db, "users", userDocSnap.id), {
                        activities: arrayUnion({ activity: 'Admin Adjust', points: -pointsToSubtract, date: Timestamp.now() })
                    });
                    updateAllLeaderboards();
                    alert(`Subtracted ${pointsToSubtract} points from ${usernameToEdit}`);
                } catch (error) { console.error("Admin subtract points error:", error); alert("Error subtracting points."); }
            });


            // Super admin password submit
            document.getElementById('submit-super-admin-password-button').addEventListener('click', () => {
                const password = document.getElementById('super-admin-password-input').value;
                if (password === 'LukeHoffman2006!') { // Keep your super admin password
                    document.getElementById('super-admin-error-message').textContent = '';
                    show('super-admin-panel');
                    document.getElementById('click-count').textContent = clickCount;
                } else {
                    document.getElementById('super-admin-error-message').textContent = 'Incorrect password';
                }
                 document.getElementById('super-admin-password-input').value = '';
            });

            // Super admin click counter
            document.getElementById('click-button').addEventListener('click', () => {
                clickCount++;
                document.getElementById('click-count').textContent = clickCount;
                localStorage.setItem('clickCount', clickCount.toString()); // Still local for this feature
                if (clickCount >= 100) {
                    document.getElementById('wipe-confirm-button').classList.remove('hidden');
                    document.getElementById('undo-wipe-button').classList.remove('hidden'); // Consider disabling/hiding this permanently for cloud
                }
            });
            
            // Wipe all points (Super Admin)
            document.getElementById('wipe-confirm-button').addEventListener('click', async () => {
                if (confirm('Are you sure you want to wipe ALL points for ALL users from Firestore? This action is hard to reverse!')) {
                    const usersRef = collection(db, "users");
                    try {
                        const querySnapshot = await getDocs(usersRef);
                        const batch = writeBatch(db);
                        querySnapshot.forEach((docSnap) => {
                            batch.update(doc(db, "users", docSnap.id), { activities: [] });
                        });
                        await batch.commit();
                        updateAllLeaderboards();
                        alert('All points have been wiped from Firestore!');
                        document.getElementById('undo-wipe-button').classList.add('hidden'); // Hide, as client-side undo is not applicable
                    } catch (error) {
                        console.error("Error wiping points: ", error);
                        alert("Failed to wipe points from Firestore.");
                    }
                }
            });

            // Undo wipe button (currently for localStorage backup, which is not used for main data anymore)
            // This button is now mostly non-functional for cloud data.
            document.getElementById('undo-wipe-button').addEventListener('click', () => {
                alert('Client-side undo is not available for cloud data. Please use Firebase backups if needed.');
            });
            
            // Initial view is handled by onAuthStateChanged
            // If not logged in, it will show 'password-panel'.
            // If logged in, it will attempt to load user data and show 'menu-panel'.
             if (!currentFirebaseUser) { // Ensure password panel shows if auth state not yet processed
                show('password-panel');
             }
        });
    </script>
</body>

</html>